<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shill or No Shill - Game Master Settings</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a url('assets/images/backgrounds/settings-gradient.svg') center/cover fixed no-repeat;
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated background elements */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 226, 0.1) 0%, transparent 50%);
            animation: backgroundShift 20s ease-in-out infinite;
            opacity: var(--bgOverlayOpacity, 0.6);
            z-index: -1;
        }

        @keyframes backgroundShift {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(2deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ffff, transparent);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .header h1 {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #00ffff, #ff00ff, #ffff00);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header p {
            font-size: 1.2rem;
            color: #cccccc;
            font-weight: 300;
            letter-spacing: 2px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .settings-panel {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 20px;
            padding: 30px;
            box-shadow:
                0 8px 32px rgba(0, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .settings-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #00ffff, #ff00ff, #00ffff);
            animation: borderGlow 2s linear infinite;
        }

        @keyframes borderGlow {
            0%, 100% { background-position: 0% 0%; }
            50% { background-position: 100% 0%; }
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: #00ffff;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .setting-group {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .setting-group:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.1);
        }

        .setting-label {
            display: block;
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 10px;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-label::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #00ffff;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .setting-description {
            font-size: 0.85rem;
            color: #aaaaaa;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 9999;
            pointer-events: none;
        }
        .toast {
            position: relative;
            max-width: 520px;
            background: rgba(0, 0, 0, 0.7);
            color: #eaffff;
            border: 1px solid rgba(0, 255, 255, 0.35);
            border-radius: 10px;
            padding: 12px 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeIn 200ms ease-out;
            pointer-events: auto;
        }
        .toast h4 { margin: 0; font-size: 0.95rem; color: #7ffcff; }
        .toast p { margin: 0; font-size: 0.85rem; color: #cfefff; }
        .toast-dismiss {
            margin-left: auto;
            width: 28px; height: 28px;
            display: grid; place-items: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.10);
            border: 1px solid rgba(255,255,255,0.18);
            color: #eaffff;
            cursor: pointer;
        }
        .toast-dismiss:hover { background: rgba(255,255,255,0.18); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

        .slider-container {
            position: relative;
            margin: 15px 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #333, #666);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .slider-value {
            display: inline-block;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            color: #000;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }


        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .setting-input {
            flex: 1;
            padding: 12px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.5);
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .setting-input:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .stepper {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stepper-btn {
            width: 30px;
            height: 30px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 50%;
            background: rgba(0, 255, 255, 0.1);
            color: #00ffff;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stepper-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .stepper-value {
            min-width: 50px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            color: #00ffff;
        }

        .crypto-tokens {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .token-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .token-option:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: rgba(0, 255, 255, 0.3);
        }

        .token-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #00ffff;
        }

        .token-option.selected {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffff;
        }

        .token-symbol {
            font-weight: bold;
            color: #00ffff;
            font-size: 0.9rem;
        }

        .token-name {
            font-size: 0.8rem;
            color: #cccccc;
        }

        .preview-section {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-top: 40px;
            text-align: center;
        }

        .preview-title {
            font-size: 2rem;
            color: #ffff00;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
        }

        .settings-summary {
            background: rgba(255, 255, 0, 0.1);
            border: 1px solid rgba(255, 255, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #ffff00;
            max-height: 300px;
            overflow-y: auto;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 40px;
            padding-bottom: 40px;
        }

        .action-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 150px;
        }

        .btn-save {
            background: linear-gradient(45deg, #4CAF50, #66BB6A);
            color: white;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .btn-launch {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        .btn-launch:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
        }

        .btn-export {
            background: linear-gradient(45deg, #FF9800, #FFC107);
            color: #000;
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .header h1 {
                font-size: 2.5rem;
            }

            .crypto-tokens {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Keep action buttons horizontal on small screens, allow wrapping */
            .action-buttons {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
                gap: 12px;
            }
        }

        /* Custom scrollbar */
        .settings-summary::-webkit-scrollbar {
            width: 8px;
        }

        .settings-summary::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .settings-summary::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            border-radius: 10px;
        }

        .settings-summary::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #ff00ff, #ffff00);
        }
    </style>
    <!-- Load Montserrat font and apply globally -->
    <link rel="stylesheet" href="assets/css/fonts.css">
    </style>
    <!-- Load Montserrat font and apply globally -->
    <link rel="stylesheet" href="assets/css/fonts.css">
    <!-- Window Titlebar Styles -->
    <style>
        .titlebar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px 0 12px;
            background: rgba(0,0,0,0.6);
            border-bottom: 1px solid rgba(255,255,255,0.12);
            backdrop-filter: blur(8px);
            -webkit-app-region: drag; /* draggable area when frameless */
            z-index: 10000;
        }
        .titlebar .app-title {
            color: #e6e6e6;
            font-size: 0.95rem;
            letter-spacing: 0.6px;
            text-shadow: 0 2px 6px rgba(0,0,0,0.6);
        }
        .titlebar .window-buttons {
            display: flex;
            gap: 6px;
            -webkit-app-region: no-drag; /* allow clicks */
        }
        .titlebar .btn {
            width: 36px; height: 24px;
            display: grid; place-items: center;
            border-radius: 6px;
            color: #fff;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.10);
            cursor: pointer;
            font-weight: 600;
            line-height: 1;
        }
        .titlebar .btn:hover { background: rgba(255,255,255,0.12); }
        .titlebar .btn:active { transform: translateY(1px); }
        .titlebar .btn-close:hover { background: #ff4d4f; border-color: #ff4d4f; }
        .titlebar-spacer { height: 36px; }
    </style>
    <link rel="stylesheet" href="assets/css/liquid-glass.css">
</head>
<body class="liquid-glass-theme">
    <div class="titlebar">
        <div class="app-title">Shill Or No Shill â€” Settings</div>
        <div class="window-buttons">
            <button id="btn-min" class="btn" title="Minimize">â€”</button>
            <button id="btn-max" class="btn" title="Maximize/Restore">â–¢</button>
            <button id="btn-close" class="btn btn-close" title="Close">âœ•</button>
        </div>
    </div>
    <div class="titlebar-spacer"></div>
    <script>
    (function(){
        const wc = window.windowControls;
        const bind = (id, fn) => { const el = document.getElementById(id); if (el) el.addEventListener('click', fn); };
        bind('btn-min', () => wc?.minimize?.());
        bind('btn-max', () => wc?.maximizeOrRestore?.());
        bind('btn-close', () => wc?.close?.());
    })();
    </script>
        <div class="header">
            <h1><img id="settingsHeaderIcon" src="assets/images/icons/settings.svg" alt="Settings" style="width:40px;height:40px;vertical-align:middle"> Game Master Control Center</h1>
            <p>Configure Your Shill or No Shill Experience</p>
        </div>
        

        <div class="settings-grid">
            <!-- Settings Preview (moved above Prize Configuration) -->
            <div class="preview-section lg-glass">
                <h2 class="preview-title">Configuration Preview</h2>
                <div class="settings-summary" id="settingsSummary">
                    Loading configuration preview...
                </div>
            </div>
            <!-- Prize Configuration Panel -->
            <div class="settings-panel">
                <h2 class="panel-title">Prize Configuration</h2>

                <!-- Max Prize Amount (replaces Prize Scale Multiplier) -->
                <div class="setting-group lg-glass">
                    <label class="setting-label">
                        Max Prize Amount ($)
                    </label>
                    <div class="setting-description">
                        Enter the maximum large prize amount. The game will scale other case values from $0 up to this maximum.
                    </div>
                    <input type="number" class="setting-input" id="maxPrizeInput" value="100" min="1" step="1" placeholder="e.g., 100" oninput="updateMaxPrizeFromInput()">
                </div>

                <!-- Number of Cases -->
                <div class="setting-group">
                    <label class="setting-label">
                        Number of Cases
                    </label>
                    <div class="setting-description">
                        Total number of briefcases available in the game.
                    </div>
                    <div class="stepper">
                        <button class="stepper-btn" onclick="changeValue('numCases', -1)">-</button>
                        <span class="stepper-value" id="numCases">25</span>
                        <button class="stepper-btn" onclick="changeValue('numCases', 1)">+</button>
                    </div>
                </div>

                <!-- Max $ Amount Boxes -->
                <div class="setting-group">
                    <label class="setting-label">
                        High-Value Cases
                    </label>
                    <div class="setting-description">
                        The number of high-value cases ($1,000 and up) to include in the randomized pool.
                    </div>
                    <div class="stepper">
                        <button class="stepper-btn" onclick="changeValue('maxDollarBoxes', -1)">-</button>
                        <span class="stepper-value" id="maxDollarBoxes">5</span>
                        <button class="stepper-btn" onclick="changeValue('maxDollarBoxes', 1)">+</button>
                    </div>
                </div>

                <!-- Zero-Amount Cases -->
                <div class="setting-group">
                    <label class="setting-label">
                        Zero-Amount Cases (Traps)
                    </label>
                    <div class="setting-description">
                        The number of cases that contain a $0.00 or $0.01 'trap' amount, adding tension.
                    </div>
                    <div class="stepper">
                        <button class="stepper-btn" onclick="changeValue('zeroCases', -1)">-</button>
                        <span class="stepper-value" id="zeroCases">1</span>
                        <button class="stepper-btn" onclick="changeValue('zeroCases', 1)">+</button>
            </div>
        </div>

                <!-- Case Value Editor Toggle -->
                <div class="setting-group">
                    <label class="setting-label">Case Value Editor Mode</label>
                    <div class="setting-description">
                        Switch between Standard Scaled Game and Custom Value Game. In Custom mode, the manual values below override scaling and zero-amount traps.
                    </div>
                    <div class="input-group">
                        <label style="display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" id="useCustomValuesToggle" onchange="toggleCustomValuesMode()">
                            Use Custom Case Values (override)
                        </label>
                    </div>
                    <div id="customModeNotice" style="display:none; margin-top:8px; font-size:0.85rem; color:#ffcc66;">
                        Custom mode enabled: Max Prize Amount and Zero-Amount Cases are disabled.
                    </div>
                </div>

                <!-- Case Value Editor Grid -->
                <div class="setting-group lg-glass" id="caseValueEditor">
                    <label class="setting-label">Case Value Editor</label>
                    <div class="setting-description">
                        Manually set the dollar amount for each briefcase. Inputs are initialized from the current scaling preview. Values are stored as strings for integrity.
                    </div>
                    <div id="caseValueGrid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:10px;">
                        <!-- populated dynamically -->
                    </div>
                    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
                        <button class="action-btn btn-save" id="applyCustomValuesBtn" onclick="applyCustomValues()">APPLY CUSTOM VALUES</button>
                        <button class="action-btn btn-export" id="clearCustomValuesBtn" onclick="clearCustomValues()">Clear Custom Values</button>
                    </div>
                </div>
            
            <!-- Game Flow Configuration Panel -->
            <div class="settings-panel">
                <h2 class="panel-title">Game Flow Configuration</h2>

                <!-- Case Opening Sequence -->
                <div class="setting-group">
                    <label class="setting-label">
                        Case Opening Sequence
                    </label>
                    <div class="setting-description">
                        The sequence defining how many cases the player must open between each Banker's Offer.
                    </div>
                    <input type="text" class="setting-input" id="caseSequence" value="6, 5, 4, 3, 2, 1" placeholder="e.g., 5, 3, 2, 1, 1">
                </div>

                <!-- Case Media Attachments -->
                <div class="setting-group lg-glass" id="caseMediaAttachments">
                    <label class="setting-label">Case Media Attachments</label>
                    <div class="setting-description">
                        Attach images (including GIFs) and custom sound effects to specific cases. These will display in a popup when that case is opened during gameplay.
                    </div>

                    <div class="custom-case-config">
                        <div class="case-selector">
                            <label>Case Number:</label>
                            <select class="setting-input" id="caseSelector" onchange="loadCaseConfig()">
                                <option value="">Select a case...</option>
                            </select>
                        </div>

                        <div class="case-customization" id="caseCustomization" style="display: none;">
                            <div class="file-input-group">
                                <label>Case Image:</label>
                                <input type="file" id="caseImage" accept="image/*" onchange="previewCaseImage(this)">
                                <div class="file-preview" id="imagePreview" style="display: none;">
                                    <img id="previewImg" src="" alt="Preview" style="max-width: 100px; max-height: 100px; border-radius: 8px;">
                                    <button type="button" onclick="clearCaseImage()">Remove</button>
                                </div>
                            </div>

                            <div class="file-input-group">
                                <label>Sound Effect:</label>
                                <input type="file" id="caseSound" accept="audio/*" onchange="previewCaseSound(this)">
                                <div class="file-preview" id="soundPreview" style="display: none;">
                                    <audio id="previewAudio" controls style="max-width: 200px;"></audio>
                                    <button type="button" onclick="clearCaseSound()">Remove</button>
                                </div>
                            </div>

                            <div class="case-actions">
                                <button class="action-btn-small" onclick="saveCaseConfig()">Save Case Config</button>
                                <button class="action-btn-small secondary" onclick="clearCaseConfig()">Clear Config</button>
                                <button class="action-btn-small" onclick="(function(){ const n = parseInt(document.getElementById('caseSelector').value); if (!n) { alert('Select a case to customize.'); return; } openCaseWizard(n); })()">Customize Wizard</button>
                                <button class="action-btn-small" onclick="testCasePopup()">Test Popup</button>
                            </div>
                        </div>
                    </div>

                    <div class="configured-cases" id="configuredCases">
                        <h4>Configured Cases:</h4>
                        <div id="casesList" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;"></div>
                    </div>
                </div>

                <!-- Banker Offer Aggressiveness -->
                <!-- Banker settings removed -->

                <!-- Cryptocurrency settings removed -->

        <!-- Advanced Settings Panel -->
        <div class="settings-panel">
            <h2 class="panel-title">Advanced Configuration</h2>

            <!-- Auto-Save Interval -->
            <div class="setting-group">
                <label class="setting-label">
                    Auto-Save Interval
                </label>
                <div class="setting-description">
                    Sets how frequently the game state is automatically saved to prevent data loss.
                </div>
                <select class="setting-input" id="autoSaveInterval" onchange="updateAutoSave()">
                    <option value="30">Every 30 seconds</option>
                    <option value="60" selected>Every 1 minute</option>
                    <option value="120">Every 2 minutes</option>
                    <option value="300">Every 5 minutes</option>
                    <option value="600">Every 10 minutes</option>
                    <option value="0">Manual save only</option>
                </select>
            </div>

            <!-- UI Effects -->
            <div class="setting-group">
                <label class="setting-label">UI Effects</label>
                <div class="setting-description">
                    Toggle interface sound effects and adjust background overlay intensity.
                </div>
                <div class="input-group" style="flex-wrap: wrap; gap:16px;">
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" id="sfxEnabledToggle"> Enable UI Sound Effects
                    </label>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span>Background Overlay:</span>
                        <input type="range" id="overlayIntensity" class="slider" min="0" max="100" value="60">
                        <span class="slider-value" id="overlayIntensityValue">60%</span>
                    </div>
                </div>
            </div>

        </div>

        

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="action-btn" id="saveSettingsBtn" onclick="saveSettings()">Save Settings</button>
            <button class="action-btn" onclick="launchGame()">Launch Game</button>
            <button class="action-btn secondary" onclick="exportSettings()">Export Settings</button>
            <button class="action-btn" id="randomizeCasePositionsBtn" onclick="randomizeCasePositions()">ðŸŽ² Randomize Case Positions</button>
            <button class="action-btn" id="saveTemplateBtn" onclick="saveSettingsAsTemplate()">ðŸ’¾ Save as Template</button>
            <button class="action-btn secondary" id="loadTemplateBtn" onclick="triggerTemplateUpload()">ðŸ“‚ Load Template</button>
        </div>
        <input type="file" id="templateFileInput" accept="application/json" style="display:none" onchange="handleTemplateFileChange(event)">
    

    <script>
        // Game Master Settings State
        let gameSettings = {
            maxPrizeAmount: 100,
            numberOfCases: 25,
            maxDollarBoxes: 5,
            zeroAmountCases: 1,
            caseOpeningSequence: [6, 5, 4, 3, 2, 1],


            autoSaveInterval: 60,
            customCaseContent: {}, // Store custom images/sounds per case
            useCustomValues: true,
            customValuesOverride: [], // store raw amounts as strings
            // UI effects
            overlayIntensity: 0.6, // 0.0 - 1.0
            sfxEnabled: true
        };

        // Simple UI tone generator (no external assets)
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let uiAudioContext = null;
        function playUITone(freq = 660, duration = 0.12, volume = 0.06) {
            try {
                if (!gameSettings.sfxEnabled || !AudioCtx) return;
                if (!uiAudioContext) uiAudioContext = new AudioCtx();
                const now = uiAudioContext.currentTime;
                const osc = uiAudioContext.createOscillator();
                const gain = uiAudioContext.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, now);
                gain.gain.setValueAtTime(volume, now);
                gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
                osc.connect(gain).connect(uiAudioContext.destination);
                osc.start(now);
                osc.stop(now + duration);
            } catch {}
        }
        function showToast(title, message, ms = 2500) {
            try {
                let container = document.getElementById('toastContainer');
                if (!container) {
                    container = document.createElement('div');
                    container.className = 'toast-container';
                    container.id = 'toastContainer';
                    document.body.appendChild(container);
                }
                const t = document.createElement('div');
                t.className = 'toast';
                const h = document.createElement('h4');
                h.textContent = title || 'Notice';
                const p = document.createElement('p');
                p.textContent = message || '';
                const x = document.createElement('button');
                x.className = 'toast-dismiss';
                x.textContent = 'Ã—';
                x.title = 'Dismiss';
                t.appendChild(h);
                if (message) t.appendChild(p);
                t.appendChild(x);
                container.appendChild(t);
                // Limit stack size
                const maxToasts = 4;
                while (container.children.length > maxToasts) {
                    try { container.children[0].remove(); } catch {}
                }
                // Subtle chime
                playUITone(660, 0.09, 0.03);
                // Auto dismiss
                const removeToast = () => { try { t.remove(); } catch {} };
                const fadeOut = () => { try { t.style.transition = 'opacity 180ms ease'; t.style.opacity = '0'; } catch {} };
                const autoTimer = setTimeout(() => { fadeOut(); setTimeout(removeToast, 220); }, Math.max(800, ms));
                x.addEventListener('click', () => { try { clearTimeout(autoTimer); } catch {}; fadeOut(); setTimeout(removeToast, 180); });
            } catch {}
        }

        // Current case being edited
        let currentEditingCase = null;

        // Cryptocurrency settings removed

        // Initialize the page
        function initializePage() {
            loadSettings();
            // Force manual values mode and seed zeros until updated
            try {
                const count = Math.max(10, Math.min(50, gameSettings.numberOfCases));
                gameSettings.useCustomValues = true;
                if (!Array.isArray(gameSettings.customValuesOverride) || gameSettings.customValuesOverride.length < count) {
                    gameSettings.customValuesOverride = Array.from({ length: count }, () => '0.00');
                }
                saveSettings();
            } catch {}

            populateCaseSelector();
            updateSettingsSummary();
            setupAutoSave();
            initializeCaseValueEditor();
            reflectCustomModeInUI();
            setupUIAudioAndOverlay();
            autoSwapAIIcons();
        }

        function setupUIAudioAndOverlay() {
            // SFX toggle
            const sfxToggle = document.getElementById('sfxEnabledToggle');
            if (sfxToggle) {
                sfxToggle.checked = !!gameSettings.sfxEnabled;
                sfxToggle.addEventListener('change', () => {
                    gameSettings.sfxEnabled = !!sfxToggle.checked;
                    saveSettings();
                });
            }

            // Overlay intensity slider
            const overlaySlider = document.getElementById('overlayIntensity');
            const overlayVal = document.getElementById('overlayIntensityValue');
            const applyOverlay = (val01) => {
                document.body.style.setProperty('--bgOverlayOpacity', String(val01));
            };
            if (overlaySlider && overlayVal) {
                // Sync from settings
                const pct = Math.round((gameSettings.overlayIntensity ?? 0.6) * 100);
                overlaySlider.value = String(pct);
                overlayVal.textContent = pct + '%';
                applyOverlay((gameSettings.overlayIntensity ?? 0.6));

                overlaySlider.addEventListener('input', () => {
                    const v = Math.max(0, Math.min(100, parseInt(overlaySlider.value || '60')));
                    overlayVal.textContent = v + '%';
                    gameSettings.overlayIntensity = v / 100;
                    applyOverlay(gameSettings.overlayIntensity);
                });
                overlaySlider.addEventListener('change', () => saveSettings());
            }

            // Button sound hooks
            const applyBtn = document.getElementById('applyCustomValuesBtn');
            if (applyBtn) applyBtn.addEventListener('click', () => playUITone(740, 0.14, 0.06));
            const saveBtn = document.getElementById('saveSettingsBtn');
            if (saveBtn) saveBtn.addEventListener('click', () => playUITone(520, 0.12, 0.06));
        }

        // Swap header/settings icons to AI variants, fallback to original on error
        function autoSwapAIIcons() {
            const imgs = Array.from(document.querySelectorAll('img'));
            imgs.forEach(img => {
                const src = img.getAttribute('src') || '';
                // Only attempt for known icons in assets/images/icons
                const m = src.match(/assets\/images\/icons\/(.*)\.svg$/);
                if (m) {
                    const baseName = m[1];
                    const aiPath = `assets/images/icons/ai/${baseName}.svg`;
                    const original = src;
                    img.onerror = () => { img.onerror = null; img.src = original; };
                    img.src = aiPath;
                }
            });
        }

        // Update Max Prize input
        function updateMaxPrizeFromInput() {
            const input = document.getElementById('maxPrizeInput');
            const val = parseFloat(input.value);
            gameSettings.maxPrizeAmount = (isFinite(val) && val > 0) ? val : 100;
            updateSettingsSummary();
        }

        // Change stepper values
        function changeValue(setting, delta) {
            switch(setting) {
                case 'numCases':
                    gameSettings.numberOfCases = Math.max(10, Math.min(50, gameSettings.numberOfCases + delta));
                    document.getElementById('numCases').textContent = gameSettings.numberOfCases;
                    // Keep the case selector in sync with the number of cases
                    populateCaseSelector();
                    // Re-render case value editor to match new count
                    renderCaseValueGrid();
                    break;
                case 'maxDollarBoxes':
                    gameSettings.maxDollarBoxes = Math.max(1, Math.min(10, gameSettings.maxDollarBoxes + delta));
                    document.getElementById('maxDollarBoxes').textContent = gameSettings.maxDollarBoxes;
                    break;
                case 'zeroCases':
                    gameSettings.zeroAmountCases = Math.max(0, Math.min(5, gameSettings.zeroAmountCases + delta));
                    document.getElementById('zeroCases').textContent = gameSettings.zeroAmountCases;
                    break;
            }
            updateSettingsSummary();
        }

        // Cryptocurrency selection removed

        // Update case opening sequence
        function updateCaseSequence() {
            const input = document.getElementById('caseSequence');
            const sequence = input.value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n > 0);
            gameSettings.caseOpeningSequence = sequence.length > 0 ? sequence : [6, 5, 4, 3, 2, 1];
            updateSettingsSummary();
        }

        // Collapsible behavior removed

        // Update settings summary
        function updateSettingsSummary() {
            const summary = document.getElementById('settingsSummary');

            // Add event listener for case sequence input
            const caseSequenceInput = document.getElementById('caseSequence');
            caseSequenceInput.removeEventListener('input', updateCaseSequence);
            caseSequenceInput.addEventListener('input', updateCaseSequence);

            // Generate sample values from $0 up to maxPrizeAmount using an exponential curve
            const sampleCount = Math.max(10, Math.min(50, gameSettings.numberOfCases));
            const max = gameSettings.maxPrizeAmount || 100;
            const gamma = 3; // curvature for spacing (higher -> more small values)
            const scaledValues = Array.from({ length: sampleCount }, (_, i) => {
                const ratio = i / (sampleCount - 1);
                const val = max * Math.pow(ratio, gamma);
                return Math.round(val * 100) / 100; // round to cents
            });

            // Build a compact table and charts
            const modeLabel = gameSettings.useCustomValues ? 'Custom Value Game' : 'Standard Scaled Game';
            summary.innerHTML = `
                <div style="margin-bottom: 12px; font-weight: 600; color: #ffea00;">Overview</div>
                <table style="width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.15); color: #fff;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 8px 12px; background: linear-gradient(90deg, rgba(255,0,255,0.18), rgba(255,255,0,0.18)); border-bottom: 1px solid rgba(255,255,255,0.2);">Metric</th>
                            <th style="text-align: left; padding: 8px 12px; background: linear-gradient(90deg, rgba(255,0,255,0.18), rgba(255,255,0,0.18)); border-bottom: 1px solid rgba(255,255,255,0.2);">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 8px 12px; border-top: 1px solid rgba(255,255,255,0.08);">Max Prize Amount</td>
                            <td style="padding: 8px 12px; border-top: 1px solid rgba(255,255,255,0.08);">${isFinite(max) ? ('$' + max.toLocaleString()) : '$100'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 12px; border-top: 1px solid rgba(255,255,255,0.08);">Total Cases</td>
                            <td style="padding: 8px 12px; border-top: 1px solid rgba(255,255,255,0.08);">${gameSettings.numberOfCases}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 12px; border-top: 1px solid rgba(255,255,255,0.08);">High-Value Cases (â‰¥$1,000)</td>
                            <td style="padding: 8px 12px; border-top: 1px solid rgba(255,255,255,0.08);">${gameSettings.maxDollarBoxes}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 12px; border-top: 1px solid rgba(255,255,255,0.08);">Zero-Amount Traps</td>
                            <td style="padding: 8px 12px; border-top: 1px solid rgba(255,255,255,0.08);">${gameSettings.zeroAmountCases}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 12px; border-top: 1px solid rgba(255,255,255,0.08);">Mode</td>
                            <td style="padding: 8px 12px; border-top: 1px solid rgba(255,255,255,0.08);">${modeLabel}</td>
                        </tr>
                    </tbody>
                </table>

                <div style="margin-top: 14px; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;"> 
                    <div style="background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; padding: 10px;">
                        <div style="font-weight: 600; margin-bottom: 6px; color: #ffea00;">Case Value Distribution</div>
                        <canvas id="valuesChart" width="600" height="240"></canvas>
                    </div>
                    <div style="background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; padding: 10px;">
                        <div style="font-weight: 600; margin-bottom: 6px; color: #ffea00;">Round Opening Sequence (cases per round)</div>
                        <canvas id="sequenceChart" width="600" height="240"></canvas>
                    </div>
                </div>
            `;

            // Keep the editor values coherent with preview when not in custom mode
            if (!gameSettings.useCustomValues) {
                renderCaseValueGrid(scaledValues);
            }

            // Render simple charts without external libraries
            drawCharts(scaledValues, gameSettings.caseOpeningSequence);
        }

        function drawCharts(values, sequence) {
            try {
                const vc = document.getElementById('valuesChart');
                const sc = document.getElementById('sequenceChart');
                if (vc) drawBarChart(vc, values, { color: '#00e5ff', yLabel: '$' });
                if (sc) drawBarChart(sc, sequence, { color: '#ff00ff', yLabel: '' });
            } catch (e) {
                console.warn('Chart render skipped:', e);
            }
        }

        function drawBarChart(canvas, data, opts) {
            if (!canvas || !data || data.length === 0) return;
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            // Scale for HiDPI
            canvas.width = canvas.width * dpr;
            canvas.height = canvas.height * dpr;
            ctx.scale(dpr, dpr);

            const width = canvas.width / dpr;
            const height = canvas.height / dpr;
            const padding = 28;
            const chartW = width - padding * 2;
            const chartH = height - padding * 2;
            const maxVal = Math.max(...data);
            const barCount = data.length;
            const gap = 2;
            const barW = Math.max(2, (chartW - gap * (barCount - 1)) / barCount);

            // Clear
            ctx.clearRect(0, 0, width, height);

            // Axes
            ctx.strokeStyle = 'rgba(255,255,255,0.35)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            // Y axis
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, padding + chartH);
            // X axis
            ctx.lineTo(padding + chartW, padding + chartH);
            ctx.stroke();

            // Grid lines
            const gridLines = 4;
            ctx.strokeStyle = 'rgba(255,255,255,0.12)';
            for (let i = 1; i <= gridLines; i++) {
                const y = padding + chartH - (chartH * i / gridLines);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartW, y);
                ctx.stroke();
            }

            // Bars
            ctx.fillStyle = opts?.color || '#00e5ff';
            const startX = padding;
            for (let i = 0; i < barCount; i++) {
                const val = data[i];
                const h = maxVal > 0 ? (val / maxVal) * chartH : 0;
                const x = startX + i * (barW + gap);
                const y = padding + chartH - h;
                ctx.fillRect(x, y, barW, h);
            }

            // Simple y-axis labels (min/mid/max)
            ctx.fillStyle = '#ffffffcc';
            ctx.font = '12px Montserrat, sans-serif';
            const minLabel = opts?.yLabel ? `${opts.yLabel}0` : '0';
            const midLabel = opts?.yLabel ? `${opts.yLabel}${Math.round(maxVal/2)}` : `${Math.round(maxVal/2)}`;
            const maxLabel = opts?.yLabel ? `${opts.yLabel}${Math.round(maxVal)}` : `${Math.round(maxVal)}`;
            ctx.fillText(minLabel, padding - 18, padding + chartH + 12);
            ctx.fillText(midLabel, padding - 28, padding + chartH/2 + 4);
            ctx.fillText(maxLabel, padding - 28, padding + 12);
        }

        // ===== CASE VALUE EDITOR (Custom Values) =====
        function computeScaledValues(count) {
            const sampleCount = Math.max(10, Math.min(50, count || gameSettings.numberOfCases));
            const max = gameSettings.maxPrizeAmount || 100;
            const gamma = 3;
            return Array.from({ length: sampleCount }, (_, i) => {
                const ratio = i / (sampleCount - 1);
                const val = max * Math.pow(ratio, gamma);
                return Math.round(val * 100) / 100; // cents
            });
        }

        function initializeCaseValueEditor() {
            renderCaseValueGrid();
        }

        function renderCaseValueGrid(previewValues) {
            const grid = document.getElementById('caseValueGrid');
            if (!grid) return;
            const count = Math.max(10, Math.min(50, gameSettings.numberOfCases));

            // Decide initial values for inputs
            let initialValues = [];
            const override = Array.isArray(gameSettings.customValuesOverride) ? gameSettings.customValuesOverride : [];
            if (override.length > 0) {
                initialValues = override.slice(0, count);
            } else {
                initialValues = Array.from({ length: count }, () => '0.00');
            }

            // If fewer values than count, pad with last known or 0
            while (initialValues.length < count) {
                initialValues.push(initialValues[initialValues.length - 1] ?? 0);
            }

            grid.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const wrapper = document.createElement('div');
                wrapper.style.cssText = 'display:flex; flex-direction:column; gap:6px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:10px; padding:10px;';

                const label = document.createElement('label');
                label.textContent = `Case ${i + 1}`;
                label.style.cssText = 'font-size:0.85rem; color:#ccc;';

                const input = document.createElement('input');
                input.type = 'text';
                input.id = `caseValueInput_${i + 1}`;
                input.className = 'setting-input';
                input.placeholder = 'e.g., 1000 or 0.01';
                // Store raw string for integrity, but hydrate with initial numeric value
                const v = initialValues[i];
                input.value = (typeof v === 'string') ? v : String(v);

                // Add per-case Customize button to open wizard
                const customizeBtn = document.createElement('button');
                customizeBtn.className = 'action-btn-small';
                customizeBtn.textContent = 'Customize';
                customizeBtn.style.cssText = 'align-self:flex-end;';
                customizeBtn.onclick = () => openCaseWizard(i + 1);

                wrapper.appendChild(label);
                wrapper.appendChild(input);
                wrapper.appendChild(customizeBtn);
                grid.appendChild(wrapper);
            }
        }

        function applyCustomValues() {
            const count = Math.max(10, Math.min(50, gameSettings.numberOfCases));
            const values = [];
            const errors = [];

            for (let i = 1; i <= count; i++) {
                const el = document.getElementById(`caseValueInput_${i}`);
                if (!el) continue;
                const raw = (el.value || '').trim();
                if (raw === '') { errors.push(`Case ${i} is empty`); continue; }
                // Validate number-like; allow commas
                const sanitized = raw.replace(/[,\s]/g, '');
                const num = Number(sanitized);
                if (!isFinite(num) || num < 0) {
                    errors.push(`Case ${i} has invalid amount`);
                }
                values.push(raw); // store raw string for integrity
            }

            if (errors.length) {
                alert('Please fix the following before applying:\n\n' + errors.join('\n'));
                return;
            }

            gameSettings.customValuesOverride = values;
            gameSettings.useCustomValues = true;
            reflectCustomModeInUI();
            saveSettings();
            updateSettingsSummary();

            // Feedback
            const btn = document.getElementById('applyCustomValuesBtn');
            const orig = btn.textContent;
            btn.textContent = 'âœ… APPLIED';
            setTimeout(() => { btn.textContent = orig; }, 1500);
        }

        function clearCustomValues() {
            gameSettings.customValuesOverride = [];
            gameSettings.useCustomValues = false;
            reflectCustomModeInUI();
            saveSettings();
            renderCaseValueGrid();
            updateSettingsSummary();
        }

        function toggleCustomValuesMode() {
            // Allow toggling custom values mode freely
            const cb = document.getElementById('useCustomValuesToggle');
            gameSettings.useCustomValues = cb ? !!cb.checked : !!gameSettings.useCustomValues;
            reflectCustomModeInUI();
            saveSettings();
            renderCaseValueGrid();
            updateSettingsSummary();
        }

        function reflectCustomModeInUI() {
            const cb = document.getElementById('useCustomValuesToggle');
            const notice = document.getElementById('customModeNotice');
            const maxPrizeInput = document.getElementById('maxPrizeInput');
            const zeroMinus = document.querySelector("button.stepper-btn[onclick=\"changeValue('zeroCases', -1)\"]");
            const zeroPlus = document.querySelector("button.stepper-btn[onclick=\"changeValue('zeroCases', 1)\"]");

            // Do not disable any inputs; always allow editing
            if (cb) { cb.checked = !!gameSettings.useCustomValues; cb.disabled = false; }
            if (notice) notice.style.display = gameSettings.useCustomValues ? 'block' : 'none';

            if (maxPrizeInput) maxPrizeInput.disabled = false;
            if (zeroMinus) zeroMinus.disabled = false;
            if (zeroPlus) zeroPlus.disabled = false;

            const editor = document.getElementById('caseValueEditor');
            if (editor) editor.style.opacity = '1';
        }

        // Save settings with robust storage fallback
        function saveSettings() {
            const key = 'shillOrNoShillSettings';
            const payload = JSON.stringify(gameSettings);

            let stored = false;
            try {
                localStorage.setItem(key, payload);
                stored = true;
                gameSettings.storageMode = 'local';
            } catch (e) {
                console.warn('localStorage save failed, falling back to sessionStorage:', e);
            }

            if (!stored) {
                try {
                    sessionStorage.setItem(key, payload);
                    stored = true;
                    gameSettings.storageMode = 'session';
                } catch (e2) {
                    console.error('sessionStorage save also failed:', e2);
                }
            }

            // Visual feedback
            const saveBtn = document.querySelector('.btn-save');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'âœ… SAVED!';
            saveBtn.style.background = 'linear-gradient(45deg, #4CAF50, #66BB6A)';

            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.background = '';
            }, 2000);

            console.log('Settings saved:', gameSettings);

            // Notify the opener (game window) that settings have been updated
            try {
                if (window.opener && typeof window.opener.postMessage === 'function') {
                    window.opener.postMessage({
                        type: 'settingsUpdated',
                        settings: gameSettings
                    }, '*');
                    console.log('Posted settingsUpdated message to opener');
                }
            } catch (e) {
                console.warn('Could not post settingsUpdated to opener:', e);
            }
        }

        // Load settings from localStorage
        function loadSettings() {
            const key = 'shillOrNoShillSettings';
            let saved = null;
            try { saved = localStorage.getItem(key); } catch (_) {}
            if (!saved) {
                try { saved = sessionStorage.getItem(key); } catch (_) {}
            }
            if (saved) {
                try {
                    const loadedSettings = JSON.parse(saved);
                    gameSettings = { ...gameSettings, ...loadedSettings };

                    // Update UI elements
                    // Max prize input
                    const mpi = document.getElementById('maxPrizeInput');
                    if (mpi) mpi.value = gameSettings.maxPrizeAmount;
                    document.getElementById('numCases').textContent = gameSettings.numberOfCases;
                    document.getElementById('maxDollarBoxes').textContent = gameSettings.maxDollarBoxes;
                    document.getElementById('zeroCases').textContent = gameSettings.zeroAmountCases;
                    document.getElementById('caseSequence').value = gameSettings.caseOpeningSequence.join(', ');
                    // UI effects
                    const sfxToggle = document.getElementById('sfxEnabledToggle');
                    if (sfxToggle) sfxToggle.checked = !!gameSettings.sfxEnabled;
                    const overlaySlider = document.getElementById('overlayIntensity');
                    const overlayVal = document.getElementById('overlayIntensityValue');
                    const pct = Math.round((gameSettings.overlayIntensity ?? 0.6) * 100);
                    if (overlaySlider) overlaySlider.value = String(pct);
                    if (overlayVal) overlayVal.textContent = pct + '%';
                    document.body.style.setProperty('--bgOverlayOpacity', String(gameSettings.overlayIntensity ?? 0.6));
                    // Banker and crypto settings removed: no UI updates necessary
                    // Reflect custom values toggle and grid
                    reflectCustomModeInUI();
                    initializeCaseValueEditor();

                } catch (e) {
                    console.error('Error loading settings:', e);
                }
            }
        }

        // Launch game with current settings
        function launchGame() {
            // Save current settings first
            saveSettings();

            // Open the main game in a new window/tab with settings
            const gameWindow = window.open('deal-or-no-deal.html', '_blank');

            // Pass settings to the game window
            if (gameWindow) {
                gameWindow.onload = function() {
                    gameWindow.postMessage({
                        type: 'gameSettings',
                        settings: gameSettings
                    }, '*');
                };
            }
        }

        // Export settings as JSON
        function exportSettings() {
            const settingsForExport = { ...gameSettings };
            const count = Math.max(10, Math.min(50, settingsForExport.numberOfCases || 25));
            if (!Array.isArray(settingsForExport.caseOrder) || settingsForExport.caseOrder.length !== count) {
                settingsForExport.caseOrder = Array.from({ length: count }, (_, i) => i + 1);
            }
            const settingsJson = JSON.stringify(settingsForExport, null, 2);
            const blob = new Blob([settingsJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'shill-or-no-shill-settings.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ===== RANDOMIZE CASE POSITIONS =====
        function randomizeCasePositions() {
            const count = Math.max(10, Math.min(50, gameSettings.numberOfCases || 25));
            const order = Array.from({ length: count }, (_, i) => i + 1);
            // Fisher-Yates shuffle
            for (let i = order.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                const tmp = order[i];
                order[i] = order[j];
                order[j] = tmp;
            }
            gameSettings.caseOrder = order;
            saveSettings();
            updateSettingsSummary();
            const btn = document.getElementById('randomizeCasePositionsBtn');
            if (btn) {
                const original = btn.textContent;
                btn.textContent = 'âœ… Randomized!';
                setTimeout(() => { btn.textContent = original; }, 1500);
            }
        }

        // ===== TEMPLATE SAVE / LOAD =====
        function saveSettingsAsTemplate() {
            const name = prompt('Enter a name for this template:', 'My Template');
            if (!name) return;

            const sanitizedName = String(name).trim().replace(/[^a-z0-9_\- ]/gi, '').replace(/\s+/g, '-');
            const template = {
                schemaVersion: '1.0',
                name: name,
                savedAt: new Date().toISOString(),
                settings: gameSettings
            };
            try {
                const json = JSON.stringify(template, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `shill-template-${sanitizedName || 'untitled'}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error('Failed to save template:', e);
                alert('Failed to save template. See console for details.');
            }
        }

        function triggerTemplateUpload() {
            const input = document.getElementById('templateFileInput');
            if (input) input.click();
        }

        function handleTemplateFileChange(ev) {
            try {
                const file = ev.target.files && ev.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const text = reader.result;
                        const obj = JSON.parse(text);
                        const incoming = obj?.settings || obj?.gameSettings || obj;
                        if (!incoming || typeof incoming !== 'object') throw new Error('Invalid template format');
                        // Merge minimal validated fields; keep current defaults where missing
                        // Ensure array lengths match numberOfCases for overrides
                        const count = Math.max(10, Math.min(50, (incoming.numberOfCases ?? gameSettings.numberOfCases) || 25));
                        if (Array.isArray(incoming.customValuesOverride)) {
                            incoming.customValuesOverride = incoming.customValuesOverride.slice(0, count);
                            while (incoming.customValuesOverride.length < count) incoming.customValuesOverride.push('0.00');
                        }
                        if (Array.isArray(incoming.caseOrder)) {
                            // Sanitize case order
                            const filtered = incoming.caseOrder.filter(n => Number.isInteger(n) && n >= 1 && n <= count);
                            const missing = [];
                            for (let n = 1; n <= count; n++) if (!filtered.includes(n)) missing.push(n);
                            incoming.caseOrder = filtered.concat(missing);
                        }
                        gameSettings = { ...gameSettings, ...incoming };
                        saveSettings();
                        // Refresh UI to reflect new settings
                        loadSettings();
                        updateSettingsSummary();
                        const modeLabel = gameSettings.useCustomValues ? 'Custom Values: ON' : 'Custom Values: OFF';
                        const countApplied = Math.max(10, Math.min(50, gameSettings.numberOfCases || 25));
                        const orderApplied = Array.isArray(gameSettings.caseOrder) ? gameSettings.caseOrder.slice(0, countApplied) : Array.from({ length: countApplied }, (_, i) => i + 1);
                        const preview = orderApplied.slice(0, 6).join(', ');
                        const ellipsis = orderApplied.length > 6 ? 'â€¦' : '';
                        showToast('Template Applied', `Cases: ${countApplied} â€¢ ${modeLabel} â€¢ Order: ${preview}${ellipsis}`);
                        const btn = document.getElementById('loadTemplateBtn');
                        if (btn) {
                            const original = btn.textContent;
                            btn.textContent = 'âœ… Template Loaded';
                            setTimeout(() => { btn.textContent = original; }, 1500);
                        }
                    } catch (e) {
                        console.error('Failed to parse template:', e);
                        alert('Failed to load template: ' + e.message);
                    } finally {
                        ev.target.value = '';
                    }
                };
                reader.readAsText(file);
            } catch (e) {
                console.error('Template upload error:', e);
            }
        }

        // ===== AUTO-SAVE FUNCTIONALITY =====
        let autoSaveTimer = null;

        function setupAutoSave() {
            if (autoSaveTimer) {
                clearInterval(autoSaveTimer);
            }

            if (gameSettings.autoSaveInterval > 0) {
                autoSaveTimer = setInterval(() => {
                    saveSettings();
                    console.log(`Auto-saved at ${new Date().toLocaleTimeString()}`);
                }, gameSettings.autoSaveInterval * 1000);
            }
        }

        function updateAutoSave() {
            const select = document.getElementById('autoSaveInterval');
            gameSettings.autoSaveInterval = parseInt(select.value);
            setupAutoSave();
            updateSettingsSummary();
        }

        // ===== CUSTOM CASE CONTENT FUNCTIONALITY =====
        function populateCaseSelector() {
            const selector = document.getElementById('caseSelector');
            selector.innerHTML = '<option value="">Select a case...</option>';

            for (let i = 1; i <= gameSettings.numberOfCases; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Case ${i}`;
                selector.appendChild(option);
            }
        }

        function loadCaseConfig() {
            const selector = document.getElementById('caseSelector');
            const caseNumber = parseInt(selector.value);

            if (!caseNumber) {
                document.getElementById('caseCustomization').style.display = 'none';
                currentEditingCase = null;
                return;
            }

            currentEditingCase = caseNumber;
            const caseConfig = gameSettings.customCaseContent[caseNumber] || {};

            document.getElementById('caseCustomization').style.display = 'block';

            // Load existing image if any
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');

            if (caseConfig.image) {
                previewImg.src = caseConfig.image;
                imagePreview.style.display = 'block';
            } else {
                imagePreview.style.display = 'none';
            }

            // Load existing sound if any
            const soundPreview = document.getElementById('soundPreview');
            const previewAudio = document.getElementById('previewAudio');

            if (caseConfig.sound) {
                previewAudio.src = caseConfig.sound;
                soundPreview.style.display = 'block';
            } else {
                soundPreview.style.display = 'none';
            }
        }

        function previewCaseImage(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImg = document.getElementById('previewImg');
                const imagePreview = document.getElementById('imagePreview');

                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function previewCaseSound(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const previewAudio = document.getElementById('previewAudio');
                const soundPreview = document.getElementById('soundPreview');

                previewAudio.src = e.target.result;
                soundPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function clearCaseImage() {
            document.getElementById('caseImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        function clearCaseSound() {
            document.getElementById('caseSound').value = '';
            document.getElementById('soundPreview').style.display = 'none';
        }

        function saveCaseConfig() {
            if (!currentEditingCase) return;

            const caseConfig = {};

            // Save image if uploaded
            const imageInput = document.getElementById('caseImage');
            if (imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    caseConfig.image = e.target.result;
                    finalizeCaseConfig(currentEditingCase, caseConfig);
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                // Keep existing image if no new one uploaded
                caseConfig.image = gameSettings.customCaseContent[currentEditingCase]?.image || null;
                finalizeCaseConfig(currentEditingCase, caseConfig);
            }
        }

        function finalizeCaseConfig(caseNumber, caseConfig) {
            // Save sound if uploaded
            const soundInput = document.getElementById('caseSound');
            if (soundInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    caseConfig.sound = e.target.result;
                    completeCaseSave(caseNumber, caseConfig);
                };
                reader.readAsDataURL(soundInput.files[0]);
            } else {
                // Keep existing sound if no new one uploaded
                caseConfig.sound = gameSettings.customCaseContent[caseNumber]?.sound || null;
                completeCaseSave(caseNumber, caseConfig);
            }
        }

        function completeCaseSave(caseNumber, caseConfig) {
            // Only save if there's content
            if (caseConfig.image || caseConfig.sound) {
                gameSettings.customCaseContent[caseNumber] = caseConfig;
            } else {
                // Remove if no content
                delete gameSettings.customCaseContent[caseNumber];
            }

            updateConfiguredCasesList();
            saveSettings();

            // Visual feedback
            const saveBtn = document.querySelector('.case-actions .action-btn-small');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'âœ… SAVED!';
            saveBtn.style.background = 'linear-gradient(45deg, #4CAF50, #66BB6A)';

            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.background = '';
            }, 1500);
        }

        function clearCaseConfig() {
            if (!currentEditingCase) return;

            delete gameSettings.customCaseContent[currentEditingCase];
            updateConfiguredCasesList();
            saveSettings();

            // Clear form
            document.getElementById('caseImage').value = '';
            document.getElementById('caseSound').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('soundPreview').style.display = 'none';

            // Visual feedback
            const clearBtn = document.querySelector('.case-actions .secondary');
            const originalText = clearBtn.textContent;
            clearBtn.textContent = 'ðŸ—‘ï¸ CLEARED!';
            clearBtn.style.background = 'linear-gradient(45deg, #f44336, #ef5350)';

            setTimeout(() => {
                clearBtn.textContent = originalText;
                clearBtn.style.background = '';
            }, 1500);
        }

        function updateConfiguredCasesList() {
            const casesList = document.getElementById('casesList');
            casesList.innerHTML = '';

            const configuredCases = Object.keys(gameSettings.customCaseContent);

            if (configuredCases.length === 0) {
                casesList.innerHTML = '<span style="color: #888; font-style: italic;">No custom cases configured</span>';
                return;
            }

            configuredCases.forEach(caseNumber => {
                const caseConfig = gameSettings.customCaseContent[caseNumber];
                const caseTag = document.createElement('div');
                caseTag.className = 'configured-case-tag';
                caseTag.style.cssText = `
                    display: inline-block;
                    padding: 4px 8px;
                    margin: 2px;
                    background: rgba(0, 255, 255, 0.2);
                    border: 1px solid rgba(0, 255, 255, 0.4);
                    border-radius: 12px;
                    font-size: 0.8rem;
                    color: #00ffff;
                    cursor: pointer;
                    transition: all 0.3s ease;
                `;

                const contentTypes = [];
                if (caseConfig.text) contentTypes.push('ðŸ“');
                if (caseConfig.image) contentTypes.push('ðŸ“·');
                if (caseConfig.sound) contentTypes.push('ðŸ”Š');
                if (caseConfig.video) contentTypes.push('ðŸŽ¬');

                caseTag.innerHTML = `Case ${caseNumber} ${contentTypes.join('')}`;
                caseTag.onclick = () => {
                    document.getElementById('caseSelector').value = caseNumber;
                    loadCaseConfig();
                };

                casesList.appendChild(caseTag);
            });
        }

        // ===== CONTEXT MODAL (TEST POPUP) =====
        function testCasePopup() {
            if (!currentEditingCase) {
                alert('Please select a case first.');
                return;
            }
            showCaseContextPopup(currentEditingCase);
        }

        function showCaseContextPopup(caseNumber) {
            const conf = gameSettings.customCaseContent[caseNumber];
            if (!conf || (!conf.image && !conf.sound && !conf.text && !conf.video)) {
                alert('No attachments configured for this case.');
                return;
            }

            const modal = document.getElementById('caseContextModal');
            const imgEl = document.getElementById('modalCaseImage');
            const audioEl = document.getElementById('modalCaseAudio');
            const textEl = document.getElementById('modalCaseText');
            const videoEl = document.getElementById('modalCaseVideo');

            if (imgEl) {
                if (conf.image) {
                    imgEl.src = conf.image;
                    imgEl.style.display = 'block';
                } else {
                    imgEl.style.display = 'none';
                    imgEl.removeAttribute('src');
                }
            }

            if (audioEl) {
                if (conf.sound) {
                    audioEl.src = conf.sound;
                    audioEl.style.display = 'block';
                    audioEl.play().catch(() => {});
                } else {
                    audioEl.style.display = 'none';
                    audioEl.removeAttribute('src');
                }
            }

            if (textEl) {
                if (conf.text) {
                    textEl.textContent = conf.text;
                    textEl.style.display = 'block';
                } else {
                    textEl.textContent = '';
                    textEl.style.display = 'none';
                }
            }

            if (videoEl) {
                if (conf.video) {
                    videoEl.src = conf.video;
                    videoEl.style.display = 'block';
                } else {
                    videoEl.style.display = 'none';
                    videoEl.removeAttribute('src');
                }
            }

            modal.style.display = 'flex';
        }

        function closeCaseContextModal() {
            const modal = document.getElementById('caseContextModal');
            const audioEl = document.getElementById('modalCaseAudio');
            if (audioEl) audioEl.pause();
            modal.style.display = 'none';
        }

        // ===== CASE WIZARD (Combine Value + Media in Progressive Steps) =====
        let caseWizardState = {
            caseNumber: null,
            stepIndex: 0,
            value: '0.00',
            text: '',
            imageData: null,
            soundData: null,
            videoData: null
        };

        function openCaseWizard(caseNumber) {
            // Hydrate state from existing settings
            try {
                caseWizardState.caseNumber = caseNumber;
                caseWizardState.stepIndex = 0;
                const idx = caseNumber - 1;
                const override = Array.isArray(gameSettings.customValuesOverride) ? gameSettings.customValuesOverride : [];
                caseWizardState.value = override[idx] ?? '0.00';
                const conf = gameSettings.customCaseContent[caseNumber] || {};
                caseWizardState.text = conf.text || '';
                caseWizardState.imageData = conf.image || null;
                caseWizardState.soundData = conf.sound || null;
                caseWizardState.videoData = conf.video || null;
            } catch {}

            // Update UI fields
            document.getElementById('cwValueInput').value = caseWizardState.value;
            document.getElementById('cwTextInput').value = caseWizardState.text;
            // Image preview
            const img = document.getElementById('cwImagePreview');
            if (caseWizardState.imageData) { img.src = caseWizardState.imageData; img.style.display = 'block'; } else { img.style.display = 'none'; }
            // Sound preview
            const aud = document.getElementById('cwSoundPreview');
            if (caseWizardState.soundData) { aud.src = caseWizardState.soundData; aud.style.display = 'block'; } else { aud.style.display = 'none'; }
            // Video preview
            const vid = document.getElementById('cwVideoPreview');
            if (caseWizardState.videoData) { vid.src = caseWizardState.videoData; vid.style.display = 'block'; } else { vid.style.display = 'none'; }

            updateWizardStepUI();
            document.getElementById('caseWizardModal').style.display = 'flex';
        }

        function closeCaseWizard() {
            const aud = document.getElementById('cwSoundPreview');
            if (aud) aud.pause();
            const vid = document.getElementById('cwVideoPreview');
            if (vid) vid.pause();
            document.getElementById('caseWizardModal').style.display = 'none';
        }

        function updateWizardStepUI() {
            const steps = document.querySelectorAll('.cw-step');
            steps.forEach((el, idx) => {
                el.style.display = (idx === caseWizardState.stepIndex) ? 'block' : 'none';
            });
            const indicators = document.querySelectorAll('.cw-step-ind');
            indicators.forEach((el, idx) => {
                el.style.opacity = (idx <= caseWizardState.stepIndex) ? '1' : '0.4';
            });
            document.getElementById('cwPrevBtn').disabled = caseWizardState.stepIndex === 0;
            document.getElementById('cwNextBtn').style.display = caseWizardState.stepIndex < 4 ? 'inline-flex' : 'none';
            document.getElementById('cwSaveBtn').style.display = caseWizardState.stepIndex === 4 ? 'inline-flex' : 'none';
        }

        function cwPrevStep() {
            if (caseWizardState.stepIndex > 0) {
                caseWizardState.stepIndex--;
                updateWizardStepUI();
            }
        }

        function cwNextStep() {
            if (caseWizardState.stepIndex < 4) {
                caseWizardState.stepIndex++;
                updateWizardStepUI();
            }
        }

        // Inputs handlers
        function cwOnValueChange(el) {
            caseWizardState.value = (el.value || '').trim();
        }
        function cwOnTextChange(el) {
            caseWizardState.text = (el.value || '').trim();
        }
        function cwOnImageSelected(el) {
            const f = el.files && el.files[0];
            if (!f) { caseWizardState.imageData = null; document.getElementById('cwImagePreview').style.display = 'none'; return; }
            const reader = new FileReader(); reader.onload = e => { caseWizardState.imageData = e.target.result; const img = document.getElementById('cwImagePreview'); img.src = caseWizardState.imageData; img.style.display = 'block'; }; reader.readAsDataURL(f);
        }
        function cwOnSoundSelected(el) {
            const f = el.files && el.files[0];
            if (!f) { caseWizardState.soundData = null; const a = document.getElementById('cwSoundPreview'); a.style.display = 'none'; a.src = ''; return; }
            const reader = new FileReader(); reader.onload = e => { caseWizardState.soundData = e.target.result; const a = document.getElementById('cwSoundPreview'); a.src = caseWizardState.soundData; a.style.display = 'block'; }; reader.readAsDataURL(f);
        }
        function cwOnVideoSelected(el) {
            const f = el.files && el.files[0];
            if (!f) { caseWizardState.videoData = null; const v = document.getElementById('cwVideoPreview'); v.style.display = 'none'; v.src = ''; return; }
            const reader = new FileReader(); reader.onload = e => { caseWizardState.videoData = e.target.result; const v = document.getElementById('cwVideoPreview'); v.src = caseWizardState.videoData; v.style.display = 'block'; }; reader.readAsDataURL(f);
        }

        function cwSaveApply() {
            const n = caseWizardState.caseNumber;
            const idx = n - 1;
            // Persist value to customValuesOverride
            const count = Math.max(10, Math.min(50, gameSettings.numberOfCases));
            if (!Array.isArray(gameSettings.customValuesOverride)) gameSettings.customValuesOverride = Array.from({ length: count }, () => '0.00');
            // Extend array if needed
            while (gameSettings.customValuesOverride.length < count) gameSettings.customValuesOverride.push('0.00');
            gameSettings.customValuesOverride[idx] = caseWizardState.value || '0.00';
            gameSettings.useCustomValues = true;

            // Persist media/text to customCaseContent
            const conf = gameSettings.customCaseContent[n] || {};
            conf.text = caseWizardState.text || '';
            conf.image = caseWizardState.imageData || null;
            conf.sound = caseWizardState.soundData || null;
            conf.video = caseWizardState.videoData || null;
            // Remove empty configs
            if (conf.text || conf.image || conf.sound || conf.video) {
                gameSettings.customCaseContent[n] = conf;
            } else {
                delete gameSettings.customCaseContent[n];
            }

            saveSettings();
            renderCaseValueGrid();
            updateConfiguredCasesList();
            reflectCustomModeInUI();

            // Feedback
            const saveBtn = document.getElementById('cwSaveBtn');
            const orig = saveBtn.textContent;
            saveBtn.textContent = 'âœ… SAVED';
            setTimeout(() => { saveBtn.textContent = orig; closeCaseWizard(); }, 900);
        }

        // Initialize when page loads
        window.onload = initializePage;
    </script>
    <!-- Case Wizard Modal -->
    <div id="caseWizardModal" class="lg-overlay" style="position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 1200;">
        <div class="lg-content" style="border-radius: 14px; padding: 16px; width: min(800px, 95vw); position: relative;">
            <button onclick="closeCaseWizard()" style="position: absolute; top: 8px; right: 8px; background: transparent; border: 1px solid rgba(0,255,255,0.5); color: #00ffff; border-radius: 6px; padding: 4px 8px; cursor: pointer;">âœ– Close</button>
            <div style="display:flex; gap:8px; margin-bottom:12px;">
                <div class="cw-step-ind" style="flex:1; height:6px; background: rgba(0,255,255,0.25); border-radius:4px; opacity:1;"></div>
                <div class="cw-step-ind" style="flex:1; height:6px; background: rgba(0,255,255,0.25); border-radius:4px; opacity:0.4;"></div>
                <div class="cw-step-ind" style="flex:1; height:6px; background: rgba(0,255,255,0.25); border-radius:4px; opacity:0.4;"></div>
                <div class="cw-step-ind" style="flex:1; height:6px; background: rgba(0,255,255,0.25); border-radius:4px; opacity:0.4;"></div>
                <div class="cw-step-ind" style="flex:1; height:6px; background: rgba(0,255,255,0.25); border-radius:4px; opacity:0.4;"></div>
            </div>
            <div style="display:block;">
                <!-- Step 1: Value -->
                <div class="cw-step" style="display:block;">
                    <label style="display:block; margin-bottom:6px;">Case Value (USD)</label>
                    <input id="cwValueInput" type="text" class="setting-input" placeholder="e.g., 1000 or 0.01" oninput="cwOnValueChange(this)">
                    <div style="font-size:0.85rem; color:#b2ffff; margin-top:6px;">This amount will be stored in Custom Values for the selected case.</div>
                </div>
                <!-- Step 2: Text -->
                <div class="cw-step" style="display:none;">
                    <label style="display:block; margin-bottom:6px;">Case Text / Notes</label>
                    <textarea id="cwTextInput" class="setting-input" style="min-height:120px;" placeholder="Any message or description shown when this case is opened." oninput="cwOnTextChange(this)"></textarea>
                </div>
                <!-- Step 3: Image -->
                <div class="cw-step" style="display:none;">
                    <label style="display:block; margin-bottom:6px;">Attach Image (png/jpg/gif)</label>
                    <input type="file" accept="image/*" class="setting-input" onchange="cwOnImageSelected(this)">
                    <div style="margin-top:8px; text-align:center;">
                        <img id="cwImagePreview" alt="Image Preview" style="max-width:100%; max-height:40vh; border-radius:8px; display:none;" />
                    </div>
                </div>
                <!-- Step 4: Sound -->
                <div class="cw-step" style="display:none;">
                    <label style="display:block; margin-bottom:6px;">Attach Sound (mp3/wav)</label>
                    <input type="file" accept="audio/*" class="setting-input" onchange="cwOnSoundSelected(this)">
                    <audio id="cwSoundPreview" controls style="width:100%; display:none; margin-top:8px;"></audio>
                </div>
                <!-- Step 5: Video -->
                <div class="cw-step" style="display:none;">
                    <label style="display:block; margin-bottom:6px;">Attach Video (mp4/webm)</label>
                    <input type="file" accept="video/*" class="setting-input" onchange="cwOnVideoSelected(this)">
                    <video id="cwVideoPreview" controls style="width:100%; display:none; margin-top:8px;"></video>
                </div>
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                <button id="cwPrevBtn" class="action-btn-small secondary" onclick="cwPrevStep()">Back</button>
                <button id="cwNextBtn" class="action-btn-small" onclick="cwNextStep()">Next</button>
                <button id="cwSaveBtn" class="action-btn btn-save" style="display:none;" onclick="cwSaveApply()">Save & Apply</button>
            </div>
        </div>
    </div>
    <!-- Context Modal for Case Media Attachments -->
    <div id="caseContextModal" class="lg-overlay" style="position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 1000;">
        <div class="lg-content" style="border-radius: 12px; padding: 16px; width: min(720px, 92vw); position: relative;">
            <button onclick="closeCaseContextModal()" style="position: absolute; top: 8px; right: 8px; background: transparent; border: 1px solid rgba(0,255,255,0.5); color: #00ffff; border-radius: 6px; padding: 4px 8px; cursor: pointer;">âœ– Close</button>
            <div id="modalText" style="display:none; margin-bottom: 10px; color:#b2ffff; font-size: 0.95rem; line-height:1.4;" ></div>
            <div id="modalImageContainer" style="text-align: center; margin-bottom: 12px;">
                <img id="modalCaseImage" alt="Case Attachment" style="max-width: 100%; max-height: 50vh; border-radius: 8px; display: none;" />
            </div>
            <video id="modalCaseVideo" controls style="width: 100%; display: none; margin-top:8px; border-radius:8px;"></video>
            <audio id="modalCaseAudio" controls style="width: 100%; display: none; margin-top:8px;"></audio>
        </div>
    </div>
    <script src="assets/js/liquid-glass.js"></script>
</body>
</html>
