<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Liquid Glass Theme – Game Master Settings</title>

    <!-- Tailwind CSS (CDN for rapid prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              accentBlue: '#21CBF3',
              accentMagenta: '#ff00ff',
              deepSurface: '#14141E',
            }
          }
        }
      }
    </script>

    <!-- Project font (optional) -->
    <link rel="stylesheet" href="assets/css/fonts.css" />

    <style>
      :root {
        --glass-bg: rgba(20, 20, 30, 0.70);
        --glass-bg-strong: rgba(20, 20, 30, 0.80);
        --accent-blue: #21CBF3;
        --accent-magenta: #ff00ff;
        --text-primary: #e5e7eb; /* Tailwind gray-200 */
        --text-dim: #9ca3af;     /* Tailwind gray-400 */
        --outer-shadow: 0 20px 60px rgba(0,0,0,0.45), 0 6px 24px rgba(0,0,0,0.35);
        --inner-highlight: inset 0 1px 0 rgba(255, 255, 255, 0.06);
      }

      /* Base app background with subtle texture */
      body {
        background: radial-gradient(1200px 600px at 20% 10%, rgba(33, 0, 66, 0.25), transparent),
                    radial-gradient(900px 600px at 80% 80%, rgba(0, 50, 120, 0.25), transparent),
                    linear-gradient(180deg, #0c0c12 0%, #0f1117 100%);
        color: var(--text-primary);
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Shared Liquid Glass surface */
      .glass-surface {
        background: var(--glass-bg);
        backdrop-filter: blur(16px) saturate(120%);
        -webkit-backdrop-filter: blur(16px) saturate(120%);
        border: 1px solid rgba(255,255,255,0.08);
        box-shadow: var(--outer-shadow);
        border-radius: 18px;
        position: relative;
        transition: all 180ms ease;
      }

      .glass-surface::before {
        /* inner highlight (top edge reflection) */
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        box-shadow: var(--inner-highlight);
        pointer-events: none;
      }

      .glass-surface:hover {
        background: var(--glass-bg-strong);
        box-shadow: 0 24px 80px rgba(0,0,0,0.50), 0 8px 28px rgba(0,0,0,0.40);
      }

      /* Subtle micro-motion */
      @keyframes shadowPulse {
        0%   { box-shadow: var(--outer-shadow); }
        50%  { box-shadow: 0 26px 90px rgba(0,0,0,0.55), 0 12px 34px rgba(0,0,0,0.45); }
        100% { box-shadow: var(--outer-shadow); }
      }

      .pulse-hover:hover {
        animation: shadowPulse 900ms ease-out 1;
      }

      /* Accent glow helpers */
      .glow-blue {
        box-shadow: 0 0 0 1px rgba(33, 203, 243, 0.3), 0 10px 30px rgba(33, 203, 243, 0.35);
      }
      .glow-magenta {
        box-shadow: 0 0 0 1px rgba(255, 0, 255, 0.25), 0 10px 30px rgba(255, 0, 255, 0.35);
      }

      /* Layout */
      .sidebar {
        width: 264px;
        height: 100vh;
        position: fixed;
        left: 20px;
        top: 20px;
        padding: 18px;
      }

      .header {
        height: 56px;
        position: fixed;
        left: 20px;
        right: 20px;
        top: 20px;
        padding: 10px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        /* Draggable area for Electron (visual designation) */
        -webkit-app-region: drag;
      }

      .header .no-drag { -webkit-app-region: no-drag; }

      .main-content {
        position: relative;
        margin-left: 20px;
        margin-top: 96px; /* header height + spacing */
        padding: 20px;
      }

      /* Window controls */
      .win-btn {
        width: 36px; height: 28px;
        display: grid; place-items: center;
        border-radius: 10px;
        background: rgba(255,255,255,0.04);
        transition: all 160ms ease;
      }
      .win-btn:hover { background: rgba(255,255,255,0.10); }

      .search-input {
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        color: var(--text-primary);
        padding: 8px 12px;
        width: 280px;
      }

      /* Cards + buttons */
      .card {
        padding: 18px;
      }

      .card-title {
        font-weight: 700;
        letter-spacing: 0.3px;
      }

      /* Configuration Preview table styles */
      .preview-table { border-collapse: separate; border-spacing: 0; width: 100%; background: transparent; }
      .preview-table th { text-align: left; font-weight: 700; padding: 10px 12px; color: var(--text-dim); border-bottom: 1px solid rgba(255,255,255,0.08); }
      .preview-table td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.06); }
      .preview-table tr:hover td { background: rgba(255,255,255,0.03); }
      .value-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .chips { display: flex; flex-wrap: wrap; gap: 8px; }
      .chip { padding: 6px 10px; border-radius: 10px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); color: #e5e7eb; box-shadow: inset 0 1px 0 rgba(255,255,255,0.06); }

      .action-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 20px;
        padding-bottom: 20px;
      }

      .action-btn {
        padding: 10px 16px;
        border: none;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 200ms ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        min-width: 150px;
        color: #0b0f14;
      }

      .btn-save {
        background: linear-gradient(135deg, #2bc85f 0%, #57e38b 100%);
        box-shadow: 0 8px 26px rgba(43, 200, 95, 0.35);
      }
      .btn-save:hover { transform: translateY(-1px); }

      .btn-launch {
        background: linear-gradient(135deg, var(--accent-blue) 0%, #58e6ff 100%);
        box-shadow: 0 8px 26px rgba(33, 203, 243, 0.35);
      }
      .btn-launch:hover { transform: translateY(-1px); }

      .btn-export {
        background: linear-gradient(135deg, #FF9800 0%, #FFC107 100%);
        box-shadow: 0 8px 26px rgba(255, 152, 0, 0.35);
      }
      .btn-export:hover { transform: translateY(-1px); }

      /* Navigation active state */
      .nav-item { opacity: 0.85; transition: opacity 160ms ease, transform 160ms ease; }
      .nav-item:hover { opacity: 1; transform: translateX(2px); }
      .nav-item.active { opacity: 1; }

      /* Modal (context window) */
      .glass-modal { position: fixed; inset: 0; display: none; place-items: center; background: rgba(10,10,16,0.55); backdrop-filter: blur(14px) saturate(120%); -webkit-backdrop-filter: blur(14px) saturate(120%); z-index: 50; }
      .glass-modal.show { display: grid; }
      .modal-content { background: var(--glass-bg); border: 1px solid rgba(255,255,255,0.08); box-shadow: var(--outer-shadow); border-radius: 18px; width: min(740px, 92vw); max-height: 86vh; overflow: hidden; position: relative; }
      .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); }
      .modal-body { padding: 16px; display: grid; gap: 12px; }
      .close-btn { position: relative; width: 32px; height: 32px; display: grid; place-items: center; border-radius: 10px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); }
      .close-btn:hover { background: rgba(255,255,255,0.12); }
      .modal-image { width: 100%; max-height: 50vh; object-fit: contain; border-radius: 12px; background: rgba(255,255,255,0.04); }
      .modal-audio { width: 100%; }

      /* Responsive tweaks */
      @media (max-width: 640px) {
        .header { position: static; margin: 16px; }
        .main-content { margin: 0 16px 16px; }
      }
    </style>
</head>
<body class="font-montserrat">
  <!-- Sidebar removed per request -->

  <!-- Header (draggable area) -->
  <header class="header glass-surface pulse-hover flex items-center">
    <div class="flex items-center gap-2">
      <input class="search-input no-drag" type="text" placeholder="Search settings..." />
    </div>
    <div class="flex items-center gap-2 no-drag">
      <button class="win-btn" title="Minimize">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="5" y="11" width="14" height="2" fill="#9ca3af"/>
        </svg>
      </button>
      <button class="win-btn" title="Maximize/Restore">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="6" y="6" width="12" height="12" stroke="#9ca3af" stroke-width="2"/>
        </svg>
      </button>
      <button class="win-btn" title="Close">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 6l12 12M18 6L6 18" stroke="#f87171" stroke-width="2"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Main content -->
  <main class="main-content">
    <!-- Configuration Preview (glass card) -->
    <section class="glass-surface card pulse-hover">
      <div class="flex items-center justify-between">
        <h2 class="card-title text-xl">Configuration Preview</h2>
        <span class="text-xs text-gray-400">Live summary</span>
      </div>
      <div class="mt-3">
        <table class="preview-table text-sm">
          <thead>
            <tr>
              <th class="w-1/3">Parameter</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody id="settingsSummaryBody"></tbody>
        </table>
        <div class="mt-4">
          <h4 class="text-sm text-gray-300 mb-2">Sample Case Values</h4>
          <div id="sampleValues" class="chips"></div>
        </div>
      </div>
    </section>

    <!-- Quick Actions -->
    <div class="action-buttons">
      <button class="action-btn btn-save">Save Configuration</button>
      <button class="action-btn btn-launch">Launch Game</button>
      <button class="action-btn btn-export">Export Settings</button>
    </div>

    <!-- Data Cards -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-2">
      <section class="glass-surface card pulse-hover">
        <h3 class="card-title text-lg mb-2">Prize Configuration</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
          <label class="flex flex-col gap-1">
            <span class="text-gray-300">Max Prize Amount ($)</span>
            <input id="maxPrizeInput" type="number" min="1" step="1" value="100"
                   class="no-drag bg-white/5 border border-white/10 rounded-md px-3 py-2 text-gray-200 focus:outline-none focus:border-accentBlue" />
          </label>
          <label class="flex flex-col gap-1">
            <span class="text-gray-300">Number of Cases</span>
            <div class="flex items-center gap-2">
              <button class="no-drag px-3 py-2 rounded-md bg-white/5 border border-white/10 text-gray-200" data-step="numCases" data-delta="-1">-</button>
              <span id="numCases" class="min-w-[40px] text-center">25</span>
              <button class="no-drag px-3 py-2 rounded-md bg-white/5 border border-white/10 text-gray-200" data-step="numCases" data-delta="1">+</button>
            </div>
          </label>
          <label class="flex flex-col gap-1">
            <span class="text-gray-300">High-Value Cases</span>
            <div class="flex items-center gap-2">
              <button class="no-drag px-3 py-2 rounded-md bg-white/5 border border-white/10 text-gray-200" data-step="maxDollarBoxes" data-delta="-1">-</button>
              <span id="maxDollarBoxes" class="min-w-[40px] text-center">5</span>
              <button class="no-drag px-3 py-2 rounded-md bg-white/5 border border-white/10 text-gray-200" data-step="maxDollarBoxes" data-delta="1">+</button>
            </div>
          </label>
          <label class="flex flex-col gap-1">
            <span class="text-gray-300">Zero-Amount Cases (Traps)</span>
            <div class="flex items-center gap-2">
              <button class="no-drag px-3 py-2 rounded-md bg-white/5 border border-white/10 text-gray-200" data-step="zeroCases" data-delta="-1">-</button>
              <span id="zeroCases" class="min-w-[40px] text-center">1</span>
              <button class="no-drag px-3 py-2 rounded-md bg-white/5 border border-white/10 text-gray-200" data-step="zeroCases" data-delta="1">+</button>
            </div>
          </label>
        </div>
      </section>

      <section class="glass-surface card pulse-hover">
        <h3 class="card-title text-lg mb-2">Game Flow Configuration</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
          <label class="flex flex-col gap-1 sm:col-span-2">
            <span class="text-gray-300">Case Opening Sequence</span>
            <input id="caseSequence" type="text" placeholder="e.g., 6,5,4,3,2,1" value="6,5,4,3,2,1"
                   class="no-drag bg-white/5 border border-white/10 rounded-md px-3 py-2 text-gray-200 focus:outline-none focus:border-accentMagenta" />
          </label>
          <label class="flex flex-col gap-1">
            <span class="text-gray-300">Auto-Save (seconds)</span>
            <input id="autoSaveInterval" type="number" min="10" step="10" value="60"
                   class="no-drag bg-white/5 border border-white/10 rounded-md px-3 py-2 text-gray-200 focus:outline-none focus:border-accentBlue" />
          </label>
        </div>
      </section>
    </div>

    <!-- Case Media Attachments (Context Window) -->
    <section class="glass-surface card pulse-hover" id="case-media-section">
      <h3 class="card-title text-lg mb-2">Case Media Attachments</h3>
      <p class="text-sm mb-4 opacity-90">Attach an image and a sound effect to a specific case. When the player selects that case, a popup will show the image and play the sound. Supports common image formats (PNG, JPG, JPEG, GIF, WEBP, SVG) and audio formats (MP3, WAV, OGG, M4A, AAC, FLAC).</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Case selection -->
        <div>
          <label class="text-sm opacity-80" for="caseSelect">Target Case</label>
          <select id="caseSelect" class="mt-2 w-full glass-input"></select>
        </div>
        <!-- Image upload -->
        <div>
          <label class="text-sm opacity-80" for="caseImage">Attach Image</label>
          <input id="caseImage" type="file" accept="image/*" class="mt-2 w-full glass-input" />
          <div id="imageError" class="text-xs mt-2 text-red-300 hidden">Unsupported image type. Please use PNG, JPG, JPEG, GIF, WEBP, or SVG.</div>
        </div>
        <!-- Image preview -->
        <div class="md:col-span-2">
          <div class="glass-surface inner-highlight p-3 flex items-center gap-3">
            <div class="text-sm opacity-80 min-w-[120px]">Image Preview</div>
            <img id="caseImagePreview" class="modal-image max-h-[200px] hidden" alt="Case image preview" />
          </div>
        </div>
        <!-- Audio upload -->
        <div>
          <label class="text-sm opacity-80" for="caseAudio">Attach Sound Effect</label>
          <input id="caseAudio" type="file" accept="audio/*" class="mt-2 w-full glass-input" />
          <div id="audioError" class="text-xs mt-2 text-red-300 hidden">Unsupported audio type. Please use MP3, WAV, OGG, M4A, AAC, or FLAC.</div>
        </div>
        <!-- Audio preview and actions -->
        <div>
          <div class="glass-surface inner-highlight p-3 flex items-center gap-3">
            <div class="text-sm opacity-80 min-w-[120px]">Sound Preview</div>
            <div id="audioPreview" class="flex items-center gap-3">
              <span id="audioFileName" class="text-xs opacity-80"></span>
              <button id="playAudioBtn" class="action-btn btn-secondary">Play</button>
              <button id="stopAudioBtn" class="action-btn btn-secondary">Stop</button>
            </div>
          </div>
        </div>
        <!-- Test popup and clear -->
        <div class="md:col-span-2 flex gap-3">
          <button id="openCasePopupBtn" class="action-btn btn-primary">Open Test Popup</button>
          <button id="clearAttachmentsBtn" class="action-btn btn-danger">Clear Attachments for Selected Case</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Simulated state for Game Master Settings
    const gameSettings = {
      maxPrizeAmount: 100,
      numberOfCases: 25,
      maxDollarBoxes: 5,
      zeroAmountCases: 1,
      caseOpeningSequence: [6, 5, 4, 3, 2, 1],
      autoSaveInterval: 60,
    };

    // Mapping of case -> { imageUrl, imageName, audioUrl, audioName }
    const caseMedia = {};

    function updateSummary() {
      const sampleCount = Math.max(10, Math.min(50, gameSettings.numberOfCases));
      const max = gameSettings.maxPrizeAmount || 100;
      const gamma = 3;
      const scaledValues = Array.from({ length: sampleCount }, (_, i) => {
        const ratio = i / (sampleCount - 1);
        const val = max * Math.pow(ratio, gamma);
        return Math.round(val);
      });

      const rows = [
        ['Max Prize Amount', `$${gameSettings.maxPrizeAmount}`],
        ['Number of Cases', gameSettings.numberOfCases],
        ['High-Value Cases', gameSettings.maxDollarBoxes],
        ['Zero-Amount Cases', gameSettings.zeroAmountCases],
        ['Case Opening Sequence', gameSettings.caseOpeningSequence.join(', ')],
        ['Auto-Save Interval', `${gameSettings.autoSaveInterval}s`]
      ];

      const tbody = document.getElementById('settingsSummaryBody');
      if (tbody) {
        tbody.innerHTML = rows
          .map(([k, v]) => `<tr><td class="text-gray-300">${k}</td><td class="value-mono">${v}</td></tr>`)
          .join('');
      }

      const chipsDiv = document.getElementById('sampleValues');
      if (chipsDiv) {
        chipsDiv.innerHTML = scaledValues
          .map(v => `<span class="chip value-mono">$${v}</span>`)
          .join('');
      }
    }

    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function handleStepper(setting, delta) {
      switch (setting) {
        case 'numCases':
          gameSettings.numberOfCases = clamp(gameSettings.numberOfCases + delta, 10, 50);
          document.getElementById('numCases').textContent = gameSettings.numberOfCases;
          break;
        case 'maxDollarBoxes':
          gameSettings.maxDollarBoxes = clamp(gameSettings.maxDollarBoxes + delta, 1, 10);
          document.getElementById('maxDollarBoxes').textContent = gameSettings.maxDollarBoxes;
          break;
        case 'zeroCases':
          gameSettings.zeroAmountCases = clamp(gameSettings.zeroAmountCases + delta, 0, 5);
          document.getElementById('zeroCases').textContent = gameSettings.zeroAmountCases;
          break;
      }
      updateSummary();
    }

    // Attach event listeners
    window.addEventListener('DOMContentLoaded', () => {
      // Inputs
      const maxPrizeInput = document.getElementById('maxPrizeInput');
      maxPrizeInput.addEventListener('input', () => {
        const val = parseFloat(maxPrizeInput.value);
        gameSettings.maxPrizeAmount = (isFinite(val) && val > 0) ? val : 100;
        updateSummary();
      });

      const autoSaveInput = document.getElementById('autoSaveInterval');
      autoSaveInput.addEventListener('input', () => {
        const val = parseInt(autoSaveInput.value, 10);
        gameSettings.autoSaveInterval = (isFinite(val) && val > 0) ? val : 60;
        updateSummary();
      });

      const caseSeqInput = document.getElementById('caseSequence');
      caseSeqInput.addEventListener('input', () => {
        const sequence = caseSeqInput.value
          .split(',')
          .map(s => parseInt(s.trim(), 10))
          .filter(n => !isNaN(n) && n > 0);
        gameSettings.caseOpeningSequence = sequence.length > 0 ? sequence : [6, 5, 4, 3, 2, 1];
        updateSummary();
      });

      // Stepper buttons
      document.querySelectorAll('[data-step]').forEach(btn => {
        btn.addEventListener('click', () => {
          const setting = btn.getAttribute('data-step');
          const delta = parseInt(btn.getAttribute('data-delta'), 10);
          handleStepper(setting, delta);
        });
      });

      // Navigation simulation
      document.querySelectorAll('.nav-item').forEach(el => {
        el.addEventListener('click', () => {
          document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
          el.classList.add('active');
        });
      });

      // Actions (simulated)
      document.querySelector('.btn-save')?.addEventListener('click', () => {
        console.log('Save Configuration clicked');
      });
      document.querySelector('.btn-launch')?.addEventListener('click', () => {
        console.log('Launch Game clicked');
      });
      document.querySelector('.btn-export')?.addEventListener('click', () => {
        console.log('Export Settings clicked');
      });

      // Case Media Attachments logic
      const caseSelect = document.getElementById('caseSelect');
      const imgInput = document.getElementById('caseImage');
      const audioInput = document.getElementById('caseAudio');
      const imgPreview = document.getElementById('caseImagePreview');
      const imgErr = document.getElementById('imageError');
      const audioErr = document.getElementById('audioError');
      const audioFileName = document.getElementById('audioFileName');
      const playAudioBtn = document.getElementById('playAudioBtn');
      const stopAudioBtn = document.getElementById('stopAudioBtn');

      let previewAudioEl = new Audio();
      const validImageExt = /\.(png|jpg|jpeg|gif|webp|svg)$/i;
      const validAudioExt = /\.(mp3|wav|ogg|m4a|aac|flac)$/i;

      function populateCaseSelect() {
        if (!caseSelect) return;
        const cur = caseSelect.value;
        caseSelect.innerHTML = '';
        for (let i = 1; i <= gameSettings.numberOfCases; i++) {
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.textContent = `Case ${i}`;
          caseSelect.appendChild(opt);
        }
        if (cur && Number(cur) <= gameSettings.numberOfCases) caseSelect.value = cur;
      }

      function getSelectedCase() { return Number(caseSelect?.value || 1); }
      function ensureCaseEntry(n) { caseMedia[n] = caseMedia[n] || { imageUrl: '', imageName: '', audioUrl: '', audioName: '' }; }
      function revokeUrl(url) { if (url) { try { URL.revokeObjectURL(url); } catch(_){} } }

      function refreshPreview() {
        const n = getSelectedCase(); ensureCaseEntry(n);
        const media = caseMedia[n];
        if (media.imageUrl) { imgPreview.src = media.imageUrl; imgPreview.classList.remove('hidden'); }
        else { imgPreview.removeAttribute('src'); imgPreview.classList.add('hidden'); }
        if (media.audioName) { audioFileName.textContent = media.audioName; } else { audioFileName.textContent = ''; }
      }

      caseSelect?.addEventListener('change', refreshPreview);

      imgInput?.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        const n = getSelectedCase(); ensureCaseEntry(n);
        if (!file) return;
        const typeOk = file.type.startsWith('image');
        const extOk = validImageExt.test(file.name);
        if (!typeOk && !extOk) { imgErr.classList.remove('hidden'); return; } else { imgErr.classList.add('hidden'); }
        revokeUrl(caseMedia[n].imageUrl);
        const url = URL.createObjectURL(file);
        caseMedia[n].imageUrl = url;
        caseMedia[n].imageName = file.name;
        refreshPreview();
      });

      audioInput?.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        const n = getSelectedCase(); ensureCaseEntry(n);
        if (!file) return;
        const typeOk = file.type.startsWith('audio');
        const extOk = validAudioExt.test(file.name);
        if (!typeOk && !extOk) { audioErr.classList.remove('hidden'); return; } else { audioErr.classList.add('hidden'); }
        revokeUrl(caseMedia[n].audioUrl);
        const url = URL.createObjectURL(file);
        caseMedia[n].audioUrl = url;
        caseMedia[n].audioName = file.name;
        audioFileName.textContent = file.name;
      });

      playAudioBtn?.addEventListener('click', () => {
        const n = getSelectedCase(); ensureCaseEntry(n);
        const url = caseMedia[n].audioUrl;
        if (!url) return;
        previewAudioEl.pause();
        previewAudioEl.src = url;
        previewAudioEl.currentTime = 0;
        previewAudioEl.play().catch(() => {
          audioErr.textContent = 'This audio might not be supported by your browser.';
          audioErr.classList.remove('hidden');
        });
      });

      stopAudioBtn?.addEventListener('click', () => {
        previewAudioEl.pause();
        previewAudioEl.currentTime = 0;
      });

      // Modal controls
      const modal = document.getElementById('caseModal');
      const modalImg = document.getElementById('modalImage');
      const modalAudio = document.getElementById('modalAudio');
      const closeModalBtn = document.getElementById('closeModal');
      const openCasePopupBtn = document.getElementById('openCasePopupBtn');
      const clearAttachmentsBtn = document.getElementById('clearAttachmentsBtn');

      function openModalForCase(n) {
        ensureCaseEntry(n);
        const media = caseMedia[n];
        if (media.imageUrl) { modalImg.src = media.imageUrl; modalImg.classList.remove('hidden'); }
        else { modalImg.removeAttribute('src'); modalImg.classList.add('hidden'); }
        if (media.audioUrl) { modalAudio.src = media.audioUrl; modalAudio.currentTime = 0; modalAudio.play().catch(() => {}); modalAudio.classList.remove('hidden'); }
        else { modalAudio.pause(); modalAudio.removeAttribute('src'); modalAudio.classList.add('hidden'); }
        modal.classList.add('show');
      }

      function closeModal() { modal.classList.remove('show'); modalAudio.pause(); }
      openCasePopupBtn?.addEventListener('click', () => openModalForCase(getSelectedCase()));
      closeModalBtn?.addEventListener('click', closeModal);
      modal?.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

      clearAttachmentsBtn?.addEventListener('click', () => {
        const n = getSelectedCase(); ensureCaseEntry(n);
        revokeUrl(caseMedia[n].imageUrl); revokeUrl(caseMedia[n].audioUrl);
        caseMedia[n] = { imageUrl: '', imageName: '', audioUrl: '', audioName: '' };
        refreshPreview();
      });

      // Initialize select and keep in sync with number of cases
      populateCaseSelect();
      document.querySelectorAll('[data-step="numCases"]').forEach(btn => {
        btn.addEventListener('click', () => setTimeout(populateCaseSelect, 0));
      });

      updateSummary();
    });
  </script>
  
  <!-- Context Modal -->
  <div id="caseModal" class="glass-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="text-sm opacity-80">Case Context</div>
        <button id="closeModal" class="close-btn" aria-label="Close">✕</button>
      </div>
      <div class="modal-body">
        <img id="modalImage" class="modal-image hidden" alt="Selected case image" />
        <audio id="modalAudio" class="modal-audio hidden" controls></audio>
      </div>
    </div>
  </div>
  </body>
</html>